(()=>{"use strict";class e{constructor(){this.counter=Number(),this.container=Object(),this.worker=new Worker(URL.createObjectURL(new Blob(["self.onmessage = function(event) {\n  const { type, counter, timeout, id } = event.data\n  if (type === 'setTimeout' || type === 'setInterval') {\n    const id = type === 'setTimeout'\n      ? setTimeout (() => self.postMessage({ type: 'setTimeout',  counter }), timeout)\n      : setInterval(() => self.postMessage({ type: 'setInterval', counter }), timeout)\n    self.postMessage({ type: 'set', counter, id })\n  } else if (type === 'clearTimeout' || type === 'clearInterval') {\n    if (type === 'clearTimeout') clearTimeout(id)\n    else if (type === 'clearInterval') clearInterval(id)\n    self.postMessage({ type: 'clear', counter })\n  }\n}\n"]))),this.worker.onmessage=this.onmessage.bind(this)}onmessage(e){const{type:t,counter:s,id:n}=e.data;"set"===t?this.container[s].id=n:"clear"===t?delete this.container[s]:"setTimeout"!==t&&"setInterval"!==t||!this.container[s]||((0,this.container[s].callback)(...this.container[s].args),"setTimeout"===t&&delete this.container[s])}setTimeout(e,t,...s){return this.setTimeWorker("setTimeout",e,t,...s)}clearTimeout(e){this.clearTimeWorker("clearTimeout",e)}setInterval(e,t,...s){return this.setTimeWorker("setInterval",e,t,...s)}clearInterval(e){this.clearTimeWorker("clearInterval",e)}setTimeWorker(e,t,s,...n){const o=++this.counter;return this.container[o]=Object(),this.container[o].callback=t,this.container[o].args=n,this.worker.postMessage({type:e,counter:o,timeout:s}),o}clearTimeWorker(e,t){if(this.container[t]){const s=this.container[t].id;this.worker.postMessage({type:e,counter:t,id:s})}}}const t=new Vue({data:{websocket:new class{constructor(){this.ws=void 0,this.wsOnMessage=void 0,this.sender=new class{constructor(){this.queue=[],this.active=!1,this.action=void 0}push(e){this.queue.push(...e),!1===this.active&&(this.active=!0,this.loop())}loop(){const e=this.queue.splice(0,1)[0];if(this.active)if(e){if(!this.action)return console.log("Sender has been destroyed."),this.active=!1,void this.queue.splice(0);if(!isNaN(Number(e)))return console.log(`Sender will wait for ${e}ms.`),void setTimeout((()=>this.loop()),Number(e));"string"==typeof e&&console.log(`"${e}"`),this.action(e),setTimeout((()=>this.loop()),256)}else this.active=!1}},this.eventEmitter=new class{constructor(){this.counter=Number(),this.container=Object(),this.listeners=Array()}on(e,t,s=!1){if("string"!=typeof e)throw new TypeError;if("function"!=typeof t)throw new TypeError;const n=++this.counter;return this.container[e]=this.container[e]||Array(),this.container[e].push(n),this.listeners[n]={counter:n,name:e,handler:t,once:s},n}once(e,t){return this.on(e,t,!0)}off(e){const t=this.listeners[e].name,s=this.container[t].indexOf(e);delete this.container[t][s],delete this.listeners[e]}emit(e,...t){const s=this.container[e];s instanceof Array&&s.forEach((e=>{const{handler:s,once:n}=this.listeners[e];"function"==typeof s&&s(...t),!0===n&&this.off(e)}))}},this.init()}init(){console.log("WebSocket: init");const e=this;if(!window.WebSocket)throw new Error("WebSocket is undefined.");unsafeWindow.WebSocket=function(t){e.ws=new window.WebSocket(t)},unsafeWindow.WebSocket.prototype={set onopen(t){console.log("WebSocket: set onopen"),e.ws.onopen=t,e.sender.send=e.ws.send},set onclose(t){console.log("WebSocket: set onclose"),e.ws.onclose=t},set onerror(t){console.log("WebSocket: set onerror"),e.ws.onerror=t},set onmessage(t){console.log("WebSocket: set onmessage"),e.wsOnMessage=t,e.ws.onmessage=t=>e.onMessage(t)},get readyState(){const t=e.ws.readyState;return 1!==t&&console.log(`WebSocket: get readyState => ${t}`),t},send:t=>e.onSend(t)}}onMessage(e){const t=function(e){const t=e.data;return"{"===t[0]?new Function(`return ${t};`)():{type:"text",text:t}}(e);this.onData(t)}onData(e){console.log(e),this.eventEmitter.emit(e.type,e);const t=function(e){return"text"===e.type&&"string"==typeof e.text?{data:e.text}:{data:JSON.stringify(e)}}(e);this.ws&&this.wsOnMessage&&this.wsOnMessage(t)}onSend(...e){e.forEach(((t,s)=>{"string"==typeof t&&/^(?!setting)/.test(t)&&/,/.test(t)&&(e[s]=t.split(","))})),this.sender.push(e.flat(1/0))}},roles:Object(),id:String(),state:String()},computed:{role(){const e=this.id,t=this.roles[e],s=Boolean(e)&&"string"==typeof e,n=Boolean(t)&&"object"==typeof t;if(s&&n)return t},name(){return this.role?this.role.name:GM_info.script.name},server(){return this.role?this.role.server:GM_info.script.version},documentTitle(){return`${this.name} ${this.state} ${this.server}`.trim()}},watch:{documentTitle(e){document.title=e}},methods:{on(e,t){return this.websocket.eventEmitter.on(e,t.bind(this))},once(e,t){return this.websocket.eventEmitter.once(e,t.bind(this))},off(e){this.websocket.eventEmitter.off(e)},send(e){this.websocket.onSend(e)},wait:e=>new Promise((t=>setTimeout((()=>t()),e)))}}),s=t;unsafeWindow.Valkyrie=t,s.on("roles",(function(e){e.roles instanceof Array&&e.roles.forEach((e=>{const{name:t,title:s,id:n}=e;this.roles[n]=this.roles[n]||Object(),this.roles[n].name=t,this.roles[n].title=s})),console.log(Object.assign(Object(),this.roles))}));const n=function(e){return document.cookie.split(";").reduce(((e,t)=>{const s=t.indexOf("="),n=t.substr(0,s).trim(),o=t.substr(s+1);return e[n]=o,e}),{})[e]};s.once("login",(function(e){const t=e.id,s=n("u"),o=n("p"),i=n("s");this.roles[t].cookie={u:s,p:o,s:i},this.roles[t].server=["一区","二区","三区","四区","测试"][i],console.log(Object.assign(Object(),this.roles))})),s.once("login",(function(e){this.send("greet master"),document.querySelector("[command=skills]").click()})),s.on("login",(function(e){e.id&&(this.id=e.id)})),s.on("state",(function(e){delete e.desc})),s.on("state",(function(e){"string"==typeof e.state?(e.state=e.state.replace(/^你正在/,""),e.state=e.state.replace(/挖矿中$/,"挖矿"),this.state=e.state):this.state=""})),s.on("combat",(function(e){this.state=1===e.start?"战斗":1===e.end?"":this.state})),s.on("die",(function(e){this.state=e.relive?"":"死亡"})),function(){const t=new e;unsafeWindow.setTimeout=t.setTimeout.bind(t),unsafeWindow.setInterval=t.setInterval.bind(t),unsafeWindow.clearTimeout=t.clearTimeout.bind(t),unsafeWindow.clearInterval=t.clearInterval.bind(t)}(),document.addEventListener("DOMContentLoaded",(function(){const e=GM_info.script.icon,t=document.createElement("link");t.setAttribute("type","image/x-icon"),t.setAttribute("rel","shortcut icon"),t.setAttribute("href",e),document.head.appendChild(t)}),!1),GM_registerMenuCommand("GreasyFork Index",(function(){window.open("https://greasyfork.org/scripts/422519")})),GM_registerMenuCommand("Github Repo",(function(){window.open("https://github.com/coderzhaoziwei/legend-of-valkyrie")}))})();