// ==UserScript==
// @name         Legend of Valkyrie
// @namespace    com.coderzhaoziwei.valkyrie
// @version      0.0.129
// @author       Coder Zhao
// @description  《武神传说》浏览器脚本程序 | Valkyrie
// @modified     2021/3/4 17:44:23
// @license      MIT
// @icon         https://cdn.jsdelivr.net/gh/coderzhaoziwei/legend-of-valkyrie/source/image/wakuang.png#12.7kb
// @supportURL   https://github.com/coderzhaoziwei/legend-of-valkyrie/issues
// @updateURL    https://github.com/coderzhaoziwei/legend-of-valkyrie/raw/main/bundle/valkyrie.min.user.js
// @match        http://*.wsmud.com/*
// @exclude      http://*.wsmud.com/news*
// @exclude      http://*.wsmud.com/pay*
// @run-at       document-start
// @require      https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.min.js
// @grant        unsafeWindow
// @grant        GM_addStyle
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_listValues
// @grant        GM_deleteValue
// @grant        GM_setClipboard
// @grant        GM_notification
// @grant        GM_registerMenuCommand
// ==/UserScript==

(()=>{"use strict";const e=new class{constructor(){this.counter=Number(),this.container=Object(),this.worker=new Worker(URL.createObjectURL(new Blob(["self.onmessage = function(event) {\n  const { type, counter, timeout, id } = event.data\n  if (type === 'setTimeout' || type === 'setInterval') {\n    const id = type === 'setTimeout'\n      ? setTimeout (() => self.postMessage({ type: 'setTimeout',  counter }), timeout)\n      : setInterval(() => self.postMessage({ type: 'setInterval', counter }), timeout)\n    self.postMessage({ type: 'set', counter, id })\n  } else if (type === 'clearTimeout' || type === 'clearInterval') {\n    if (type === 'clearTimeout') clearTimeout(id)\n    else if (type === 'clearInterval') clearInterval(id)\n    self.postMessage({ type: 'clear', counter })\n  }\n}\n"]))),this.worker.onmessage=this.onmessage.bind(this)}onmessage(e){const{type:t,counter:s,id:o}=e.data;"set"===t?this.container[s].id=o:"clear"===t?delete this.container[s]:"setTimeout"!==t&&"setInterval"!==t||!this.container[s]||((0,this.container[s].callback)(...this.container[s].args),"setTimeout"===t&&delete this.container[s])}setTimeout(e,t,...s){return this.setTimeWorker("setTimeout",e,t,...s)}clearTimeout(e){this.clearTimeWorker("clearTimeout",e)}setInterval(e,t,...s){return this.setTimeWorker("setInterval",e,t,...s)}clearInterval(e){this.clearTimeWorker("clearInterval",e)}setTimeWorker(e,t,s,...o){const n=++this.counter;return this.container[n]=Object(),this.container[n].callback=t,this.container[n].args=o,this.worker.postMessage({type:e,counter:n,timeout:s}),n}clearTimeWorker(e,t){if(this.container[t]){const s=this.container[t].id;this.worker.postMessage({type:e,counter:t,id:s})}}};["setTimeout","setInterval","clearTimeout","clearInterval"].forEach((t=>unsafeWindow[t]=e[t].bind(e)));const t=new Vue({data:{websocket:new class{constructor(){this.ws=void 0,this.wsOnMessage=void 0,this.sender=void 0,this.eventEmitter=new class{constructor(){this.counter=Number(),this.container=Object(),this.listeners=Array()}on(e,t,s=!1){if("string"!=typeof e)throw new TypeError;if("function"!=typeof t)throw new TypeError;const o=++this.counter;return this.container[e]=this.container[e]||Array(),this.container[e].push(o),this.listeners[o]={counter:o,name:e,handler:t,once:s},o}once(e,t){return this.on(e,t,!0)}off(e){const t=this.listeners[e].name,s=this.container[t].indexOf(e);delete this.container[t][s],delete this.listeners[e]}emit(e,...t){const s=this.container[e];s instanceof Array&&s.forEach((e=>{const{handler:s,once:o}=this.listeners[e];"function"==typeof s&&s(...t),!0===o&&this.off(e)}))}},this.init()}init(){console.log("WebSocket: init");const e=this;if(!window.WebSocket)throw new Error("WebSocket is undefined.");unsafeWindow.WebSocket=function(t){e.ws=new window.WebSocket(t)},unsafeWindow.WebSocket.prototype={set onopen(t){console.log("WebSocket: set onopen"),e.ws.onopen=t},set onclose(t){console.log("WebSocket: set onclose"),e.ws.onclose=t},set onerror(t){console.log("WebSocket: set onerror"),e.ws.onerror=t},set onmessage(t){console.log("WebSocket: set onmessage"),e.wsOnMessage=t,e.ws.onmessage=t=>e.onMessage(t)},get readyState(){const t=e.ws.readyState;return 1!==t&&console.log(`WebSocket: get readyState => ${t}`),t},send:t=>e.onSend(t)}}onMessage(e){const t=function(e){const t=e.data;return"{"===t[0]?new Function(`return ${t};`)():{type:"text",text:t}}(e);this.onData(t)}onData(e){console.log(e),this.eventEmitter.emit(e.type,e);const t=function(e){return"text"===e.type&&"string"==typeof e.text?{data:e.text}:{data:JSON.stringify(e)}}(e);this.ws&&this.wsOnMessage&&this.wsOnMessage(t)}onSend(...e){void 0===this.sender&&(this.sender=new class{constructor(e){this.readystate=Boolean(),this.queue=Array(),this.handler=e}send(...e){this.queue.push(...e),!1===this.readystate&&(this.readystate=!0,this.loop())}async loop(e=256){const t=this.queue.splice(0,1)[0];var s;!1!==this.readystate&&(void 0===this.handler?(console.log("Sender handler has been destroyed."),this.queue.splice(0),this.readystate=!1):void 0===t?this.readystate=!1:function(e){const t=Number(e),s="number"==typeof t,o=!1===isNaN(t);return s&&o}(t)?(e=Number(t),this.loop(e)):(await new Promise((t=>setTimeout((()=>t()),e))),"string"!=typeof(s=t)||""===s?"function"==typeof t&&t():(console.log(t),this.handler(t)),this.loop()))}}((e=>this.ws.send(e)))),e.forEach(((t,s)=>{"string"==typeof t&&/^(?!setting)/.test(t)&&/,/.test(t)&&(e[s]=t.split(","))})),this.sender.send(...e.flat(1/0))}},roles:Object(),id:String(),state:String(),room:Object(),prop:Object()},computed:{role(){const e=this.id,t=this.roles[e],s=Boolean(e)&&"string"==typeof e,o=Boolean(t)&&"object"==typeof t;if(s&&o)return t},name(){return this.role?this.role.name:GM_info.script.name},server(){return this.role?this.role.server:GM_info.script.version},documentTitle(){return`${this.name} ${this.state} ${this.server}`.trim()},npcs(){const e=Array();return this.room.items instanceof Array&&this.room.items.forEach((t=>t.isNpc&&e.push(t))),e},jy(){return parseInt(this.prop.exp)||0},qn(){return parseInt(this.prop.pot)||0},hp1(){return parseInt(this.prop.hp)||0},hp2(){return parseInt(this.prop.max_mp)||0},mp1(){return parseInt(this.prop.mp)||0},mp2(){return parseInt(this.prop.max_mp)||0},mp3(){return parseInt(this.prop.limit_mp)||0},wx1(){return parseInt(this.prop.int)||0},wx2(){return parseInt(this.prop.int_add)||0},xxxl(){return parseInt(this.prop.study_per)||0},lxxl(){return parseInt(this.prop.lianxi_per)||0}},watch:{documentTitle(e){document.title=e}},methods:{on(e,t){return this.websocket.eventEmitter.on(e,t.bind(this))},once(e,t){return this.websocket.eventEmitter.once(e,t.bind(this))},off(e){this.websocket.eventEmitter.off(e)},send(...e){this.websocket.onSend(...e)},wait:e=>new Promise((t=>setTimeout((()=>t()),e)))}}),s=t;unsafeWindow.Valkyrie=t,s.on("roles",(function(e){e.roles instanceof Array&&e.roles.forEach((e=>{const{name:t,title:s,id:o}=e;this.roles[o]=this.roles[o]||Object(),this.roles[o].name=t,this.roles[o].title=s})),console.log(Object.assign(Object(),this.roles))}));const o=function(e){return document.cookie.split(";").reduce(((e,t)=>{const s=t.indexOf("="),o=t.substr(0,s).trim(),n=t.substr(s+1);return e[o]=n,e}),{})[e]};s.once("login",(function(e){const t=e.id,s=o("u"),n=o("p"),i=o("s");void 0===this.roles[t]&&(this.roles[t]=Object()),this.roles[t].cookie={u:s,p:n,s:i},this.roles[t].server=["一区","二区","三区","四区","测试"][i],console.log(Object.assign(Object(),this.roles)),console.log(`Script: ${GM_info.script.name} ${GM_info.script.version}`),console.log(`UserAgent: ${navigator.userAgent}`)})),s.once("login",(function(e){this.send("pack,score2,score",(()=>document.querySelector("[command=skills]").click()),(()=>document.querySelector("[command=tasks]").click()),(()=>{0===document.querySelector(".right-bar").offsetWidth&&document.querySelector("[command=showtool]").click()}),(()=>{0===document.querySelector(".content-bottom").offsetHeight&&document.querySelector("[command=showcombat]").click()}),(()=>document.querySelector(".dialog-close").click()))})),s.on("login",(function(e){e.id&&(this.id=e.id)})),s.on("state",(function(e){delete e.desc})),s.on("state",(function(e){"string"==typeof e.state?(e.state=e.state.replace(/^你正在/,""),e.state=e.state.replace(/挖矿中$/,"挖矿"),this.state=e.state):this.state=""})),s.on("combat",(function(e){this.state=1===e.start?"战斗":1===e.end?"":this.state})),s.on("die",(function(e){this.state=e.relive?"":"死亡"})),s.on("room",(function(e){let{name:t,path:s,desc:o,commands:n}=e;if("new/new1"===s&&(o=o.replace("<cmd cmd='look yizi'><hig>椅子</hig></cmd>","<cmd cmd='look yizi,zuo2 yizi'>椅子</cmd>")),"yz/by/bingying"===s&&(o=o.replace("<CMD cmd='look men'>门(men)<CMD>",'<cmd cmd="look men,open men">门</cmd>')),"gumu/woshi"!==s&&"gumu/qinshi"!==s||(o=o.replace("<cmd cmd='look chuang'>石床</cmd>",'<cmd cmd="look chuang,zuo chuang">石床</cmd>').replace("<span cmd='look hua'>画</span>",'<cmd cmd="look hua">画</cmd>').replace("<span cmd='look qin'>古琴</span>",'<cmd cmd="look qin,tan qin">古琴</cmd>')),/cmd/.test(o)){console.log(o),o=o.replace(/'/g,'"').replace(/\([A-Za-z]+?\)/g,"");const e=o.match(/<cmd cmd="[^"]+?">[^<]+?<\/cmd>/g);e&&e.forEach((e=>{/<cmd cmd="([^"]+?)">([^<]+?)<\/cmd>/.test(e)&&n.unshift({cmd:RegExp.$1,name:`<hig>${RegExp.$2}</hig>`})}))}this.room={name:t,path:s,desc:o,commands:n},e.desc=o,e.commands=n})),s.on("exits",(function(e){this.room.exits||(this.room.exits=Object()),Object.keys(this.room.exits).forEach((e=>delete this.room.exits[e])),"object"==typeof e.items&&Object.keys(e.items).forEach((t=>{const s=t,o=e.items[s],n=`go ${s}`;this.room.exits[o]={dir:s,command:n}}))}));s.on("items",(function(e){this.room.items||(this.room.items=Array()),this.room.items.splice(0);const t=Array();e.items&&e.items instanceof Array&&e.items.forEach((e=>{0!==e&&"object"==typeof e&&(e.isSelf=e.id===this.id,t.push(new class{constructor(e){this.id=e.id,this.name=e.name,this.hp=e.hp||0,this.mp=e.mp||0,this.max_hp=e.max_hp||0,this.max_mp=e.max_mp||0,this.status=e.status||Array(),this.p=e.p||0,this.isSelf=e.isSelf}get isPlayer(){return 1===this.p}get isOffline(){return this.name.includes("<red>&lt;断线中&gt;</red>")}get isNpc(){return!this.isPlayer}get index(){return this.isSelf?0:this.isNpc?this.color+100:this.isOffline?this.color+300:this.color+200}get color(){return[/^<hir>/i,/^<hio>/i,/^<hiz>/i,/^<hic>/i,/^<hiy>/i,/^<hig>/i,/^<wht>/i,/\S/].findIndex((e=>e.test(this.name)))+1}}(e)))})),t.sort(((e,t)=>e.index-t.index)),e.items=t,this.room.items.push(...t)})),document.addEventListener("DOMContentLoaded",(function(){const e=GM_info.script.icon,t=document.createElement("link");t.setAttribute("type","image/x-icon"),t.setAttribute("rel","shortcut icon"),t.setAttribute("href",e),document.head.appendChild(t)}),!1),GM_registerMenuCommand("GreasyFork Index",(function(){window.open("https://greasyfork.org/scripts/422519")})),GM_registerMenuCommand("Github Repo",(function(){window.open("https://github.com/coderzhaoziwei/legend-of-valkyrie")}))})();
